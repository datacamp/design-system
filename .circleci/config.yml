version: 2.1
orbs:
  datacamp-ecr: datacamp/ecr@0
  datacamp-deploy: datacamp/deploy@1
jobs:
  build:
    docker:
      - image: circleci/node:12.4.0-browsers
    steps:
      - checkout
      - run:
          name: Copy NPM config
          command: cp ci/.npmrc .npmrc
      - run:
          name: Install lerna
          command: yarn global add lerna
      - run:
          name: Install and Build
          command: yarn bootstrap
      - persist_to_workspace:
          root: "."
          paths:
            - ./**
  test:
    docker:
      - image: circleci/node:12.4.0-browsers
    steps:
      - attach_workspace:
          at: "."
      - run:
          name: Lint
          command: yarn lint
      - run:
          name: Lint commits
          command: yarn commitlint:ci
      - run:
          name: Test
          command: yarn test
      - run:
          name: Check types
          command: yarn type-check
  upload-to-percy:
    docker:
      - image: circleci/node:12.4.0-browsers
    steps:
      - attach_workspace:
          at: "."
      - run:
          name: Upload to percy
          command: yarn percy
  deploy-staging-site:
    docker:
      - image: ${STAGING_ECR_URL}/docker-deploy
        aws_auth:
          aws_access_key_id: $STAGING_AWS_ACCESS_KEY_ID
          aws_secret_access_key: $STAGING_AWS_SECRET_ACCESS_KEY
    environment:
      BUCKET: waffles
      CLOUDFRONT_ID: E16EOD0ZWD0L66
    steps:
      - attach_workspace:
          at: "."
      - run:
          name: S3 Sync
          command: |
            export AWS_ACCESS_KEY_ID=${STAGING_AWS_ACCESS_KEY_ID}
            export AWS_SECRET_ACCESS_KEY=${STAGING_AWS_SECRET_ACCESS_KEY}
            aws s3 sync --delete --acl public-read packages/docs/catalog-doc-site/catalog/build s3://${BUCKET}.datacamp-staging.com/live
            #aws s3 sync --acl public-read packages/docs/catalog-doc-site/catalog/build/static/media s3://${BUCKET}.datacamp-staging.com/live/media
      - run:
          name: Invalidate Cache
          command: |
            export AWS_ACCESS_KEY_ID=$STAGING_AWS_ACCESS_KEY_ID
            export AWS_SECRET_ACCESS_KEY=$STAGING_AWS_SECRET_ACCESS_KEY
            aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_ID} --paths "/index.html"
  deploy-doc-site:
    docker:
      - image: ${STAGING_ECR_URL}/docker-deploy
        aws_auth:
          aws_access_key_id: $STAGING_AWS_ACCESS_KEY_ID
          aws_secret_access_key: $STAGING_AWS_SECRET_ACCESS_KEY
    environment:
      BUCKET: waffles
      CLOUDFRONT_ID: E596C189UKISL
    steps:
      - attach_workspace:
          at: "."
      - run:
          name: S3 Sync
          command: |
            export AWS_ACCESS_KEY_ID=${PROD_AWS_ACCESS_KEY_ID}
            export AWS_SECRET_ACCESS_KEY=${PROD_AWS_SECRET_ACCESS_KEY}
            aws s3 sync --delete --exclude "*le-components/*" --acl public-read packages/docs/catalog-doc-site/catalog/build s3://${BUCKET}.new.datacamp.com/live
            #aws s3 sync --acl public-read packages/docs/catalog-doc-site/catalog/build/static/media s3://${BUCKET}.new.datacamp.com/live/media
      - run:
          name: Invalidate Cache
          command: |
            export AWS_ACCESS_KEY_ID=$PROD_AWS_ACCESS_KEY_ID
            export AWS_SECRET_ACCESS_KEY=$PROD_AWS_SECRET_ACCESS_KEY
            aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_ID} --paths "/index.html"

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build:
          context: org-global
          filters:
            tags:
              only: /.*/
      - test:
          requires:
            - build
          context: org-global
          filters:
            tags:
              only: /.*/
      - hold-for-pr:
          type: approval
          context: org-global
          filters:
            tags:
              only: /.*/
      - upload-to-percy:
          requires:
            - test
            - hold-for-pr
          context: org-global
      - upload-to-percy:
          requires:
            - test
          name: upload-to-percy-master
          context: org-global
          filters:
            branches:
              only: /master/
      - datacamp-ecr/build_and_push_image_to_ecr:
          requires:
            - test
            - hold-for-pr
          name: push-storybook-image
          context: org-global
          aws-access-key-id: $STAGING_AWS_ACCESS_KEY_ID
          aws-secret-access-key: $STAGING_AWS_SECRET_ACCESS_KEY
          account-url: $STAGING_ECR_URL
          repo: waffles-storybook
          path: packages/docs/storybook
          dockerfile: packages/docs/storybook/Dockerfile
          pre-build-steps:
            - attach_workspace:
                at: "."
          filters:
            branches:
              ignore: /dependabot.*/
      - datacamp-deploy/backstage-deploy: # backstage
          name: deploy-storybook
          context: org-global
          file: packages/docs/storybook/ecs.backstage.json
          extra-env: "BRANCH=${CIRCLE_BRANCH//\\//-}"
          new-deploy-opt-in: true
          deploy-url: $STAGING_LAMBDA_DEPLOY_URL
          deploy-password: $STAGING_LAMBDA_DEPLOY_PASSWORD
          requires:
            - push-storybook-image
      - deploy-staging-site:
          requires:
            - test
          context: org-global
          filters:
            branches:
              only:
                - staging
      - deploy-doc-site:
          requires:
            - test
          context: org-global
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /.*/
